import { createSignal, For, onMount, Show } from "solid-js";
import { taskStore, taskActions } from "../stores/taskStore";
import { queueActions } from "../stores/queueStore";
import type {
  CreateTaskRequest,
  UpdateTaskRequest,
  Task,
  TaskHierarchy,
} from "../types/task";
import { Button } from "../components/Button";
import { Card } from "../components/Card";
import { Dialog } from "../components/Dialog";
import { Input } from "../components/Input";

export function TaskPage() {
  const [isCreateDialogOpen, setIsCreateDialogOpen] = createSignal(false);
  const [editingTask, setEditingTask] = createSignal<TaskHierarchy | null>(null);
  const [formData, setFormData] = createSignal<CreateTaskRequest>({
    title: "",
    description: "",
    tags: [],
  });
  const [expandedTasks, setExpandedTasks] = createSignal<Set<string>>(new Set());

  // コンポーネントマウント時にタスク階層を読み込み
  onMount(() => {
    taskActions.loadHierarchy();
  });

  // タスクの展開/折りたたみをトグル
  const toggleExpanded = (taskId: string) => {
    setExpandedTasks((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(taskId)) {
        newSet.delete(taskId);
      } else {
        newSet.add(taskId);
      }
      return newSet;
    });
  };

  const handleCreate = async (e: Event) => {
    e.preventDefault();
    try {
      await taskActions.createTask(formData());
      await taskActions.loadHierarchy();
      setIsCreateDialogOpen(false);
      setFormData({ title: "", description: "", tags: [] });
    } catch (error) {
      console.error("Failed to create task:", error);
      alert(`タスクの作成に失敗しました: ${error}`);
    }
  };

  const handleUpdate = async (e: Event) => {
    e.preventDefault();
    const task = editingTask();
    if (!task) return;

    try {
      const updateData: UpdateTaskRequest = {
        title: formData().title,
        description: formData().description,
        parentId: formData().parentId,
      };
      await taskActions.updateTask(task.id, updateData);
      await taskActions.loadHierarchy();
      setEditingTask(null);
      setFormData({ title: "", description: "", tags: [] });
    } catch (error) {
      console.error("Failed to update task:", error);
      alert(`タスクの更新に失敗しました: ${error}`);
    }
  };

  const handleDelete = async (taskId: string) => {
    // TODO: Tauriのダイアログプラグインを使用して確認ダイアログを表示
    try {
      await taskActions.deleteTask(taskId);
      await taskActions.loadHierarchy(); // タスク階層を再読み込み
    } catch (error) {
      console.error("Failed to delete task:", error);
      alert(`削除に失敗しました: ${error}`);
    }
  };

  const handleAddToQueue = async (taskId: string) => {
    try {
      await queueActions.addToQueue(taskId);
      // タスク階層を再読み込み（ステータスがActiveに変わるため）
      await taskActions.loadHierarchy();
    } catch (error) {
      console.error("Failed to add to queue:", error);
      alert(`キューへの追加に失敗しました: ${error}`);
    }
  };

  const openEditDialog = (task: TaskHierarchy) => {
    setEditingTask(task);
    setFormData({
      title: task.title,
      description: task.description || "",
      tags: task.tags,
      parentId: task.parentId,
    });
  };

  // 階層構造をフラット化してタスクリストを取得（親タスク選択用）
  const flattenHierarchy = (hierarchy: TaskHierarchy[]): TaskHierarchy[] => {
    if (!hierarchy || hierarchy.length === 0) {
      return [];
    }
    const result: TaskHierarchy[] = [];
    const flatten = (tasks: TaskHierarchy[]) => {
      tasks.forEach((task) => {
        result.push(task);
        if (task.children && task.children.length > 0) {
          flatten(task.children);
        }
      });
    };
    flatten(hierarchy);
    return result;
  };

  // 完了タスクかどうか
  const isCompleted = (task: TaskHierarchy) => task.status === "completed";

  // タスクカードのスタイルを取得
  const getTaskCardStyle = (task: TaskHierarchy) => {
    if (isCompleted(task)) {
      return "opacity-70 bg-green-50";
    }
    return "bg-white";
  };

  // ステータスバッジのスタイルを取得
  const getStatusBadgeStyle = (status: string) => {
    switch (status) {
      case "draft":
        return "bg-gray-100 text-gray-800";
      case "active":
        return "bg-blue-100 text-blue-800";
      case "completed":
        return "bg-green-100 text-green-800";
      case "archived":
        return "bg-gray-200 text-gray-600";
      default:
        return "bg-gray-100 text-gray-800";
    }
  };

  // タスクカードを再帰的にレンダリング（階層構造版）
  const renderTaskCard = (task: TaskHierarchy, depth: number = 0) => {
    const hasChildren = task.children.length > 0;
    const isExpanded = () => expandedTasks().has(task.id);
    const completed = isCompleted(task);

    return (
      <>
        <Card
          style={{ "margin-left": `${depth * 24}px` }}
          class={getTaskCardStyle(task)}
        >
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-2">
                {hasChildren && (
                  <button
                    onClick={() => toggleExpanded(task.id)}
                    class="text-gray-400 hover:text-gray-600 text-sm cursor-pointer focus:outline-none"
                  >
                    {isExpanded() ? "▼" : "▶"}
                  </button>
                )}
                <h3
                  class="text-lg font-semibold"
                  classList={{
                    "line-through text-gray-500": completed,
                    "text-gray-900": !completed,
                  }}
                >
                  {task.title}
                </h3>
                {/* Completed チェックマーク */}
                {completed && (
                  <span class="text-green-600 font-bold" title="完了">
                    ✓
                  </span>
                )}
              </div>
              <Show when={task.description}>
                <p class="mt-1 text-gray-600">{task.description}</p>
              </Show>
              <div class="mt-2 flex items-center gap-2">
                <span
                  class={`px-2 py-1 text-xs font-medium rounded ${getStatusBadgeStyle(
                    task.status
                  )}`}
                >
                  {task.status}
                </span>
                <Show when={task.tags.length > 0}>
                  <div class="flex gap-1">
                    <For each={task.tags}>
                      {(tag) => (
                        <span class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">
                          {tag}
                        </span>
                      )}
                    </For>
                  </div>
                </Show>
              </div>
            </div>
            <div class="flex gap-2">
              {/* Completed タスクはキュー追加ボタン非表示 */}
              <Show when={task.status === "draft" && !completed}>
                <Button
                  onClick={() => handleAddToQueue(task.id)}
                  class="bg-blue-600 hover:bg-blue-700 text-white"
                >
                  キューへ追加
                </Button>
              </Show>
              <Button
                variant="secondary"
                onClick={() => openEditDialog(task)}
                disabled={completed}
              >
                編集
              </Button>
              <Button variant="danger" onClick={() => handleDelete(task.id)}>
                削除
              </Button>
            </div>
          </div>
        </Card>
        <Show when={isExpanded()}>
          <For each={task.children}>
            {(child) => renderTaskCard(child, depth + 1)}
          </For>
        </Show>
      </>
    );
  };

  return (
    <div class="h-screen flex flex-col bg-gray-50">
      <div class="flex-1 flex flex-col p-8">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h1 class="text-3xl font-bold text-gray-900">タスクプール</h1>
            <p class="text-sm text-gray-600 mt-1">
              新しいタスクはここに追加されます
            </p>
          </div>
          <Button onClick={() => setIsCreateDialogOpen(true)}>
            新規タスク作成
          </Button>
        </div>

        <Show when={taskStore.error}>
          <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
            {taskStore.error}
            <button
              class="ml-4 underline"
              onClick={() => taskActions.clearError()}
            >
              閉じる
            </button>
          </div>
        </Show>

        <Show when={taskStore.loading}>
          <div class="text-center py-8 text-gray-600">読み込み中...</div>
        </Show>

        <div class="flex-1 overflow-y-auto">
          <div class="space-y-4">
            <Show
              when={taskStore.hierarchy.length > 0}
              fallback={
                <Card>
                  <p class="text-center text-gray-500 py-8">
                    タスクがありません。新規作成してください。
                  </p>
                </Card>
              }
            >
              <For each={taskStore.hierarchy}>
                {(task) => renderTaskCard(task)}
              </For>
            </Show>
          </div>
        </div>

        {/* 新規作成ダイアログ */}
        <Dialog
          open={isCreateDialogOpen()}
          onOpenChange={setIsCreateDialogOpen}
          title="新規タスク作成"
        >
          <form onSubmit={handleCreate} class="space-y-4">
            <Input
              label="タイトル"
              value={formData().title}
              onInput={(e) =>
                setFormData({ ...formData(), title: e.currentTarget.value })
              }
              required
            />
            <div class="flex flex-col gap-1">
              <label class="text-sm font-medium text-gray-700">親タスク</label>
              <select
                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                value={formData().parentId || ""}
                onChange={(e) =>
                  setFormData({
                    ...formData(),
                    parentId: e.currentTarget.value || undefined,
                  })
                }
              >
                <option value="">なし（ルートタスク）</option>
                <For each={flattenHierarchy(taskStore.hierarchy)}>
                  {(task) => (
                    <option value={task.id}>{task.title}</option>
                  )}
                </For>
              </select>
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-sm font-medium text-gray-700">説明</label>
              <textarea
                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                rows={4}
                value={formData().description}
                onInput={(e) =>
                  setFormData({
                    ...formData(),
                    description: e.currentTarget.value,
                  })
                }
              />
            </div>
            <div class="flex gap-2 justify-end">
              <Button
                type="button"
                variant="secondary"
                onClick={() => setIsCreateDialogOpen(false)}
              >
                キャンセル
              </Button>
              <Button type="submit">作成</Button>
            </div>
          </form>
        </Dialog>

        {/* 編集ダイアログ */}
        <Dialog
          open={editingTask() !== null}
          onOpenChange={(open) => !open && setEditingTask(null)}
          title="タスク編集"
        >
          <form onSubmit={handleUpdate} class="space-y-4">
            <Input
              label="タイトル"
              value={formData().title}
              onInput={(e) =>
                setFormData({ ...formData(), title: e.currentTarget.value })
              }
              required
            />
            <div class="flex flex-col gap-1">
              <label class="text-sm font-medium text-gray-700">親タスク</label>
              <select
                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                value={formData().parentId || ""}
                onChange={(e) =>
                  setFormData({
                    ...formData(),
                    parentId: e.currentTarget.value || undefined,
                  })
                }
              >
                <option value="">なし（ルートタスク）</option>
                <For
                  each={flattenHierarchy(taskStore.hierarchy).filter(
                    (task) => task.id !== editingTask()?.id
                  )}
                >
                  {(task) => <option value={task.id}>{task.title}</option>}
                </For>
              </select>
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-sm font-medium text-gray-700">説明</label>
              <textarea
                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                rows={4}
                value={formData().description}
                onInput={(e) =>
                  setFormData({
                    ...formData(),
                    description: e.currentTarget.value,
                  })
                }
              />
            </div>
            <div class="flex gap-2 justify-end">
              <Button
                type="button"
                variant="secondary"
                onClick={() => setEditingTask(null)}
              >
                キャンセル
              </Button>
              <Button type="submit">更新</Button>
            </div>
          </form>
        </Dialog>
      </div>
    </div>
  );
}
